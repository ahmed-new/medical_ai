<!doctype html>
<html lang="ar" dir="ltr">
{% load static %}
<head>
  <meta charset="utf-8">
  <title>{% block title %}Ù…Ù†ØµÙ‘Ø© Ø§Ù„Ø¯Ø±Ø§Ø³Ø©{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root { --brand:#3a6ff8; --muted:#6c757d; --bg:#f7f8fa; --card:#fff; }
    body{ background:var(--bg); }
    .app-header{ background:#fff; border-bottom:1px solid #eee; }
    .app-brand{ color:var(--brand); font-weight:700; text-decoration:none; }
    .app-nav .nav-link{ color:#444; font-weight:500; }
    .app-nav .nav-link.active{ color:var(--brand); }
    .page-title{ font-size:1.1rem; font-weight:700; }
    .card-soft{ background:var(--card); border:1px solid #eee; border-radius:14px; }
    .app-brand-logo{
      height: 60px;      /* Ø¬Ø±Ù‘Ø¨ 32â€“40px ÙˆØ´ÙˆÙ Ø§Ù„Ø£Ù†Ø³Ø¨ */
      width: auto;
      display: block;
    }

    /* Floating Study button (bigger) */
    .fab-pomo {
      position: fixed; right: 16px; bottom: 16px; z-index: 1040;
      padding: 14px 22px; font-size: 1.05rem; font-weight: 700;
      box-shadow: 0 10px 20px rgba(0,0,0,.12);
    }
    /* HUD */
    .pomo-hud { position: fixed; right: 16px; bottom: 88px; z-index: 1040; min-width: 240px; }
    .pomo-time { font-size: 1.4rem; letter-spacing: 1px; }

    .htmx-indicator { display: none; }
    .htmx-request .htmx-indicator,
    .htmx-request.htmx-indicator { display: inline-block; }

        /* ===== AI Chat widget ===== */
    /* ===== AI Chat widget ===== */
    #ai-chat-widget{
      position: fixed;
      left: 18px;          /* Ø¨Ø¯Ù„ right */
      bottom: 18px;
      z-index: 1080;
      font-size: 14px;
    }

    .ai-chat-btn{
      border-radius: 999px;
      padding: 10px 18px;  /* Ø²Ø±Ø§Ø± Ø£ÙƒØ¨Ø± Ø´ÙˆÙŠØ© */
      border: none;
      background: #0d6efd;
      color:#fff;
      box-shadow: 0 8px 24px rgba(15,23,42,.35);
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:600;
      font-size: 15px;
    }

    .ai-chat-panel{
      position: absolute;
      left: 0;             /* ØªÙØªØ­ ÙÙˆÙ‚ Ø§Ù„Ø²Ø±Ø§Ø± Ù†Ø§Ø­ÙŠØ© Ø§Ù„Ø´Ù…Ø§Ù„ */
      bottom: 52px;
      /* ØªØ§Ø®Ø¯ ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§ ØªÙ„Øª Ø§Ù„Ø´Ø§Ø´Ø© ÙÙŠ Ø§Ù„Ø¯ÙŠØ³ÙƒØªÙˆØ¨ØŒ Ù…Ø¹ Ø­Ø¯ Ø£Ù‚ØµÙ‰ Ù…Ø­ØªØ±Ù… */
      width: min(520px, 34vw);
      height: min(80vh, 640px);  /* Ø¨Ø§Ù†Ù„ Ø·ÙˆÙŠÙ„Ø© ÙˆÙˆØ§Ø¶Ø­Ø© */
      background: #ffffff;
      border-radius: 18px;
      box-shadow: 0 16px 40px rgba(15,23,42,.45);
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }

    .ai-chat-header{
      padding: 12px 16px;
      border-bottom:1px solid rgba(148,163,184,.4);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      font-size: 15px;
      font-weight: 600;
    }

    .ai-chat-messages{
      padding: 12px 16px;
      overflow-y:auto;
      /* Ù†Ø®Ù„ÙŠÙ‡Ø§ ØªÙ…Ù„Ù‰ Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© Ø¨Ø¯Ù„ max-height Ø«Ø§Ø¨Øª */
      flex: 1;
      max-height:none;
      background:#f8fafc;
      display:flex;
      flex-direction:column;
      gap: 4px;
      font-size: 15px;        /* Ø£ÙˆØ¶Ø­ Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© */
    }

    .ai-msg{
      padding:8px 12px;
      border-radius:12px;
      margin-bottom:4px;
      white-space:pre-wrap;
      line-height: 1.5;
    }

    .ai-msg-bot{
      background:#e5edff;
      align-self:flex-start;
    }

    .ai-msg-user{
      background:#0d6efd;
      color:#fff;
      align-self:flex-end;
    }

    .ai-chat-form{
      padding: 10px;
      border-top:1px solid rgba(148,163,184,.4);
      display:flex;
      gap:8px;
      background:#fff;
    }

    .ai-chat-btn .ai-chat-icon{
      width: 26px;
      height: 26px;
      object-fit: contain;
      display:block;
    }

    /* Ù…ÙˆØ¨Ø§ÙŠÙ„: Ù†Ø®Ù„ÙŠÙ‡Ø§ Ø´Ø¨Ù‡ full-screen Ø¹Ù„Ø´Ø§Ù† Ø§Ù„Ø·Ø§Ù„Ø¨ ÙŠÙƒØªØ¨ Ø¨Ø±Ø§Ø­Ø© */
    @media (max-width: 576px){
      .ai-chat-panel{
        width: 100vw;
        left: 0;
        bottom: 0;
        height: 88vh;                 /* ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§ Ø§Ù„Ø´Ø§Ø´Ø© ÙƒÙ„Ù‡Ø§ */
        border-radius: 18px 18px 0 0; /* Ù…Ù† ÙÙˆÙ‚ Ø¨Ø³ */
      }

      .ai-chat-messages{
        flex: 1;
        max-height:none;
      }
    }


  </style>

  {% block extra_head %}{% endblock %}
</head>
<body>

<header class="app-header">
  <div class="container py-2 d-flex align-items-center justify-content-between">
    {% include "_partials/_header.html" %}
  </div>
  <div class="border-top">
    <div class="container">
      {% include "_partials/_nav.html" %}
    </div>
  </div>
</header>

<main class="container py-3">
  {% block content %}{% endblock %}
</main>

<footer class="mt-5">
  <div class="container py-4 text-center text-muted">
    {% include "_partials/_footer.html" %}
  </div>
</footer>

{% block extra_js %}{% endblock %}



{% if request.session.access %}
<!-- Study Modal -->
<div class="modal fade" id="pomodoroModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0">
      <div class="modal-header">
        <h5 class="modal-title">Select Study Time</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div class="mb-2 small text-muted">ğŸŒ³ Each 25 min builds a tree</div>

        <div class="input-group mb-3" style="max-width: 300px;">
          <span class="input-group-text">â±</span>
          <select id="pomodoro-duration" class="form-select">
            <option value="20">min 20</option>
            <option value="25" selected>min 25</option>
            <option value="30">min 30</option>
            <option value="40">min 40</option>
          </select>
          <span class="input-group-text">ğŸ•‘</span>
        </div>

        <div id="pomodoro-ticker" class="display-4 fw-semibold text-center my-3" style="letter-spacing:2px;">
          25:00
        </div>

        <div class="d-flex gap-2">
          <button id="pomodoro-stop"  class="btn btn-outline-secondary flex-fill" disabled>Stop</button>
          <button id="pomodoro-start" class="btn btn-primary flex-fill">Start Now</button>
        </div>

        <div id="pomodoro-msg" class="alert alert-secondary mt-3 d-none">â€”</div>
      </div>
    </div>
  </div>
</div>

<!-- Congrats -->
<div class="modal fade" id="pomodoroDone" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 text-center">
      <div class="modal-body p-4">
        <div class="display-5 mb-2">ğŸŒ³</div>
        <h5 class="mb-1">Congratulations</h5>
        <div class="text-muted mb-3">You have built a tree!</div>
        <div class="d-flex gap-2 justify-content-center">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Take Rest</button>
          <button class="btn btn-primary" data-bs-dismiss="modal" data-bs-toggle="modal" data-bs-target="#pomodoroModal">Study More</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Floating Study button (big) -->
<button id="fabStudy" class="btn btn-primary rounded-pill fab-pomo" data-bs-toggle="modal" data-bs-target="#pomodoroModal">
  â± Study 25 mins
</button>

<!-- HUD -->
<div id="pomoHUD" class="pomo-hud d-none">
  <div class="card shadow-sm border-0">
    <div class="card-body d-flex align-items-center justify-content-between gap-2">
      <div class="pomo-time fw-bold" id="pomoHUDTime">25:00</div>
      <div class="btn-group btn-group-sm">
        <button id="pomoHUDPause"  class="btn btn-outline-secondary">Pause</button>
        <button id="pomoHUDResume" class="btn btn-outline-secondary d-none">Resume</button>
        <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#pomodoroModal">â‹¯</button>
        <button id="pomoHUDStop"   class="btn btn-outline-danger">Stop</button>
      </div>
    </div>
  </div>
</div>

<!-- ===== AI Chat floating widget ===== -->
<div id="ai-chat-widget">
  <!-- Ø§Ù„Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ø§Ø¦Ù… -->
 <button type="button" id="aiChatToggle" class="ai-chat-btn">
  <img src="{% static 'logos/ai.png' %}" alt="AI" class="ai-chat-icon">
  <span>Ask AI</span>
</button>



  <!-- Ø§Ù„Ø¨Ø§Ù†Ù„ -->
  <div id="ai-chat-panel" class="ai-chat-panel d-none">
    <div class="ai-chat-header">
      <div>
        <div class="fw-semibold">Axonelix AI tutor</div>
        <div class="small text-muted">Ask about your materials & questions</div>
      </div>
      <button type="button" class="btn-close btn-sm" id="ai-chat-close" aria-label="Close"></button>
    </div>

    <div id="ai-chat-messages" class="ai-chat-messages">
      <div class="ai-msg ai-msg-bot">
        ğŸ‘‹ Hi! Ask me anything about your medical materials or questions.
      </div>
    </div>

    <form id="ai-chat-form" class="ai-chat-form">
      {% csrf_token %}
      <input
        id="ai-chat-input"
        type="text"
        class="form-control form-control-sm"
        placeholder="Type your question and press Enter..."
        autocomplete="off"
      >
      <button class="btn btn-primary btn-sm" type="submit" id="ai-chat-send">
        <span class="spinner-border spinner-border-sm d-none" id="ai-chat-spin" role="status"></span>
        <span id="ai-chat-send-label">Send</span>
      </button>
    </form>
  </div>
</div>
{% endif %}
<!-- JS: Bootstrap Bundle + HTMX -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/htmx.org@1.9.12"></script>
<script>
  // ====== CSRF once ======
  function getCookie(name){const m=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)');return m?m.pop():''}
  document.body.addEventListener('htmx:configRequest', e => { e.detail.headers['X-CSRFToken']=getCookie('csrftoken'); });

  // ====== Elements (modal + HUD) ======
  const durSel   = document.getElementById('pomodoro-duration');
  const ticker   = document.getElementById('pomodoro-ticker');
  const btnStart = document.getElementById('pomodoro-start');
  const btnStop  = document.getElementById('pomodoro-stop');
  const msg      = document.getElementById('pomodoro-msg');
  const modalEl  = document.getElementById('pomodoroModal');
  const fab      = document.getElementById('fabStudy');

  const hud      = document.getElementById('pomoHUD');
  const hudTime  = document.getElementById('pomoHUDTime');
  const hudPause = document.getElementById('pomoHUDPause');
  const hudResume= document.getElementById('pomoHUDResume');
  const hudStop  = document.getElementById('pomoHUDStop');

  // ====== Persistent state in localStorage ======
  const STORAGE_KEY = 'pomo_state_v1';

  // state schema:
  // {
  //   running: bool, paused: bool,
  //   total: seconds, started_ms: epoch_ms,
  //   paused_accum: seconds,     // Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ØªÙˆÙ‚ÙØ§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
  //   paused_start_ms: epoch_ms|null  // Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªÙˆÙ‚Ù Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ùˆ paused=true
  // }
  let state = {
    running:false, paused:false,
    total: 25*60,
    started_ms: null,
    paused_accum: 0,
    paused_start_ms: null,
    timer_id: null,
  };

  const fmt = s => { s=Math.max(0,Math.floor(s)); const m=Math.floor(s/60), ss=s%60; return `${String(m).padStart(2,'0')}:${String(ss).padStart(2,'0')}`; };
  const setFabLabel = mins => { if (fab) fab.textContent = `â± Study ${mins} mins`; };

  function saveState(){
    const toSave = {
      running: state.running,
      paused: state.paused,
      total: state.total,
      started_ms: state.started_ms,
      paused_accum: state.paused_accum,
      paused_start_ms: state.paused_start_ms
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(toSave));
  }

  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      const s = JSON.parse(raw);
      // validate
      if (typeof s.total !== 'number' || !s.started_ms) return;
      state.running = !!s.running;
      state.paused  = !!s.paused;
      state.total   = s.total;
      state.started_ms = s.started_ms;
      state.paused_accum = s.paused_accum || 0;
      state.paused_start_ms = s.paused_start_ms || null;
    }catch(_){}
  }

  function nowMs(){ return Date.now(); }

  // remaining seconds based on wall clock
  function remainingSeconds(){
    if (!state.started_ms) return state.total;
    const now = nowMs();
    const pausedExtra = state.paused && state.paused_start_ms ? Math.max(0, Math.floor((now - state.paused_start_ms)/1000)) : 0;
    const pausedTotal = state.paused_accum + pausedExtra;
    const elapsed = Math.max(0, Math.floor((now - state.started_ms)/1000) - pausedTotal);
    return state.total - elapsed;
  }

  function showHUD(){
    hud.classList.remove('d-none');
    hudPause.classList.toggle('d-none', state.paused || !state.running);
    hudResume.classList.toggle('d-none', !state.paused);
  }
  function hideHUD(){ hud.classList.add('d-none'); }

  function render(){
    const left = remainingSeconds();
    if (ticker)  ticker.textContent  = fmt(left);
    if (hudTime) hudTime.textContent = fmt(left);
  }

  function startInterval(){
    if (state.timer_id) return;
    state.timer_id = setInterval(()=>{
      render();
      const left = remainingSeconds();
      if (left <= 0){
        clearInterval(state.timer_id); state.timer_id=null;
        // complete
        const minutes = Math.round(state.total/60);
        const startedISO = new Date(state.started_ms).toISOString();
        resetRunning(false); // don't log elapsed again here
        postSession(minutes, startedISO, true);
      }
    }, 1000);
  }
  function stopInterval(){ if (state.timer_id){ clearInterval(state.timer_id); state.timer_id=null; } }

  function resetRunning(keepUI=false){
    stopInterval();
    state.running=false; state.paused=false;
    state.started_ms=null; state.paused_accum=0; state.paused_start_ms=null;
    saveState();
    hideHUD();
    if (!keepUI){
      // Ù„Ø§ ØªØºÙŠÙ‘Ø± Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±ØŒ ÙÙ‚Ø· Ø£Ø¹ÙØ¯ Ø§Ù„Ø¹Ø±Ø¶ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
      const mins = parseInt(durSel?.value || String(Math.round(state.total/60)), 10) || 25;
      state.total = mins*60;
      render();
    }
  }

  // ====== Session actions ======
  function startSession(){
    if (state.running) return;
    const mins = parseInt(durSel.value || '25', 10);
    state.total = mins*60;
    state.started_ms = nowMs();
    state.paused_accum = 0;
    state.paused_start_ms = null;
    state.running = true; state.paused = false;
    saveState();
    showHUD();
    render();
    startInterval();
  }

  function pauseSession(){
    if (!state.running || state.paused) return;
    state.paused = true;
    state.paused_start_ms = nowMs();
    saveState();
    showHUD();
    render();
  }

  function resumeSession(){
    if (!state.running || !state.paused) return;
    // Ø£Ø¶ÙÙ Ù…Ø¯Ø© Ø§Ù„ØªÙˆÙ‚Ù Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¬Ù…Ø¹
    const now = nowMs();
    if (state.paused_start_ms) {
      state.paused_accum += Math.max(0, Math.floor((now - state.paused_start_ms)/1000));
    }
    state.paused = false;
    state.paused_start_ms = null;
    saveState();
    showHUD();
    render();
  }

  function stopSession(logElapsed=true){
    if (!state.started_ms){ resetRunning(); return; }
    // Ø§Ø­Ø³Ø¨ Ø§Ù„Ù…Ù†Ù‚Ø¶ÙŠ Ø§Ù„ÙØ¹Ù„ÙŠ
    const left = remainingSeconds();
    const elapsedMin = Math.max(0, Math.round((state.total - left)/60));
    const startedISO = new Date(state.started_ms).toISOString();
    resetRunning();
    if (logElapsed && elapsedMin >= 1){
      postSession(elapsedMin, startedISO, false);
    }
  }

  // ====== UI bindings ======
  function updateForSelect(){
    const mins = parseInt(durSel.value || '25', 10);
    setFabLabel(mins);
    if (!state.running){
      state.total = mins*60;
      render();
    }
  }
  if (durSel) durSel.addEventListener('change', updateForSelect);

  if (btnStart) btnStart.addEventListener('click', ()=>{
    if (!state.running) startSession();
    if (window.bootstrap) bootstrap.Modal.getOrCreateInstance(modalEl).hide();
  });

  if (btnStop) btnStop.addEventListener('click', ()=> stopSession(true));

  if (hudPause)  hudPause.addEventListener('click', pauseSession);
  if (hudResume) hudResume.addEventListener('click', resumeSession);
  if (hudStop)   hudStop.addEventListener('click', ()=> stopSession(true));

  if (modalEl){
    modalEl.addEventListener('show.bs.modal', ()=>{
      // Ø§Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
      if (state.running){
        // Ø§Ø¶Ø¨Ø· select Ø¹Ù„Ù‰ Ù…Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        const m = String(Math.round(state.total/60));
        if (durSel && durSel.value !== m) durSel.value = m;
        btnStart.disabled = true; btnStop.disabled = false;
      }else{
        btnStart.disabled = false; btnStop.disabled = true;
      }
      render();
    });
    modalEl.addEventListener('hidden.bs.modal', ()=>{ if (state.running) showHUD(); });
  }

  window.addEventListener('beforeunload', saveState);

  // ====== API call ======
  async function postSession(minutes, startedISO, showCongrats){
    try{
      const res = await fetch("{% url 'pomodoro_log' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
          "X-CSRFToken": getCookie("csrftoken"),
        },
        body: new URLSearchParams({minutes:String(minutes), started_at: startedISO}),
      });
      const js = await res.json();
      if (js.ok){
        // Ø­Ø¯Ù‘Ø« Ø¹Ø¯Ù‘Ø§Ø¯Ø§Øª Ø§Ù„ØµÙØ­Ø© Ø¥Ù† ÙˆØ¬Ø¯Øª
        try{
          const elMin=document.getElementById('study-today-min');
          const elTrees=document.getElementById('trees-today');
          if (elMin){
            const newMin=(parseInt(elMin.textContent||'0',10)+minutes);
            elMin.textContent=String(newMin);
            if (elTrees) elTrees.textContent=String(Math.floor(newMin/25));
          }
        }catch(_){}
        if (showCongrats && window.bootstrap){
          bootstrap.Modal.getOrCreateInstance(document.getElementById('pomodoroDone')).show();
        }
      }
    }catch(e){ console.warn('pomodoro_log error', e); }
  }

  // ====== Restore & boot ======
  (function boot(){
    // Ø§Ø¶Ø¨Ø· Ù„Ø§Ø¨Ù„ Ø§Ù„Ø²Ø± (25 Ø§ÙØªØ±Ø§Ø¶ÙŠ)
    setFabLabel(25);
    // Ø­Ù…Ù‘Ù„ Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ùˆ ÙÙŠ Ø¬Ù„Ø³Ø© Ù‚Ø§Ø¦Ù…Ø©
    loadState();

    // Ù„Ùˆ Ø§Ù„Ø¬Ù„Ø³Ø© Ù‚Ø§Ø¦Ù…Ø©ØŒ Ø§Ø³ØªØ£Ù†Ù ÙÙˆØ±Ù‹Ø§
    if (state.running){
      showHUD();
      render();
      startInterval();
      // Ø§Ø¶Ø¨Ø· Ù„Ø§Ø¨Ù„ Ø§Ù„Ø²Ø± Ø¹Ù„Ù‰ Ù…Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø©
      setFabLabel(Math.round(state.total/60));
    }else{
      // Ø§Ø³ØªØ®Ø¯Ù… Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠØ©
      const mins = parseInt(durSel?.value || '25', 10);
      state.total = mins*60;
      render();
      setFabLabel(mins);
    }
  })();
</script>

<!-- ===== AI Chat JS ===== -->
<script>
  (function(){
    const toggleBtn = document.getElementById("aiChatToggle");
    const panel     = document.getElementById("ai-chat-panel");
    const closeBtn  = document.getElementById("ai-chat-close");
    const form      = document.getElementById("ai-chat-form");
    const input     = document.getElementById("ai-chat-input");
    const msgsBox   = document.getElementById("ai-chat-messages");
    const sendBtn   = document.getElementById("ai-chat-send");
    // Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ† Ø¨Ø³ Ù…Ø´ Ø¨Ù†Ø³ØªØ®Ø¯Ù…Ù‡Ù… ÙƒÙ€ indicator Ø¯Ù„ÙˆÙ‚ØªÙ‰
    const spin      = document.getElementById("ai-chat-spin");
    const sendLabel = document.getElementById("ai-chat-send-label");

    // ====== ØªØ®Ø²ÙŠÙ† Ù…Ø­Ù„Ù‰ Ù„Ù„Ù‡Ø³ØªÙˆØ±ÙŠ ======
    const AI_STORAGE_KEY = "ax_ai_chat_history_v1";
    let chatHistory = [];

    function saveChatHistory(){
      try {
        localStorage.setItem(AI_STORAGE_KEY, JSON.stringify(chatHistory));
      } catch(e) {
        // ignore
      }
    }

    function loadChatHistory(){
      try {
        const raw = localStorage.getItem(AI_STORAGE_KEY);
        if (!raw) return;
        const arr = JSON.parse(raw);
        if (Array.isArray(arr)){
          chatHistory = arr.slice(-10);
        }
      } catch(e) {
        // ignore
      }
    }

    // ====== ÙØªØ­/ØºÙ„Ù‚ Ø§Ù„Ø¨Ø§Ù†Ù„ ======
    function openPanel(){
      if (!panel) return;
      panel.classList.remove("d-none");
      setTimeout(()=> input && input.focus(), 50);
    }
    function closePanel(){
      if (!panel) return;
      panel.classList.add("d-none");
    }

    toggleBtn?.addEventListener("click", function(){
      if (!panel) return;
      if (panel.classList.contains("d-none")) openPanel();
      else closePanel();
    });
    closeBtn?.addEventListener("click", closePanel);

    // ====== Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ù€ UI + ØªØ­Ø¯ÙŠØ« history ======
    function appendMsg(text, who, opts){
      opts = opts || {};
      const div = document.createElement("div");
      div.className = "ai-msg " + (who === "user" ? "ai-msg-user" : "ai-msg-bot");
      if (opts.thinking){
        div.dataset.thinking = "1";
      }
      div.textContent = text;
      msgsBox.appendChild(div);
      msgsBox.scrollTop = msgsBox.scrollHeight;

      // Ù…Ø§ Ù†Ø¶ÙŠÙØ´ thinking / Ø±Ø³Ø§Ø¦Ù„ Ù…Ø¹ÙŠÙ†Ø© Ù„Ù„Ù‡Ø³ØªÙˆØ±ÙŠ Ù„Ùˆ skipHistory=true
      if (!opts.skipHistory && !opts.thinking){
        chatHistory.push({
          role: (who === "user" ? "user" : "assistant"),
          content: text
        });
        if (chatHistory.length > 10){
          chatHistory = chatHistory.slice(-10);
        }
        saveChatHistory();
      }
      return div;
    }

    // ====== ØªØ£Ø«ÙŠØ± Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¨Ø·ÙŠØ¦Ø© ======
    function typeOut(text, el, speed){
      return new Promise(resolve => {
        let i = 0;
        el.textContent = "";
        function step(){
          if (i >= text.length){
            return resolve();
          }
          el.textContent += text[i];
          i++;
          if (msgsBox){
            msgsBox.scrollTop = msgsBox.scrollHeight;
          }
          setTimeout(step, speed);
        }
        step();
      });
    }

    // ====== Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù„Ù„Ø¨Ø§Ùƒ + thinking bubble ======
    async function sendQuestion(q){
      // bubble "Thinking..." Ø¯Ø§Ø®Ù„ Ø§Ù„Ø´Ø§Øª
      const thinkingDiv = appendMsg("Thinkingâ€¦", "bot", {
        thinking: true,
        skipHistory: true
      });

      try{
        // DEBUG Ø¨Ø³ÙŠØ· Ù„Ùˆ Ø­Ø§Ø¨Ø¨ ØªØªØ§Ø¨Ø¹
        // console.log("Sending history to backend:", chatHistory);

        const res = await fetch("{% url 'web_ai_ask' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
            "X-CSRFToken": getCookie("csrftoken"),
          },
          body: new URLSearchParams({
            q: q,
            history: JSON.stringify(chatHistory)   // ØªÙ…Ø±ÙŠØ± Ø¢Ø®Ø± 10 Ø±Ø³Ø§Ø¦Ù„ Ù„Ù„Ø¨Ø§Ùƒ
          })
        });

        const js = await res.json();
        let answerText;
        if (js.answer){
          answerText = js.answer;
        } else if (js.error){
          answerText = js.error;
        } else {
          answerText = "Something went wrong.";
        }

        thinkingDiv.dataset.thinking = "0";
        await typeOut(answerText, thinkingDiv, 15);

        // Ø¶ÙŠÙ Ø§Ù„Ø±Ø¯ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù„Ù„Ù‡Ø³ØªÙˆØ±ÙŠ Ø¨Ø¹Ø¯ Ù…Ø§ ÙŠØ®Ù„Øµ ÙƒØªØ§Ø¨Ø©
        chatHistory.push({ role: "assistant", content: answerText });
        if (chatHistory.length > 10){
          chatHistory = chatHistory.slice(-10);
        }
        saveChatHistory();

      } catch(e){
        const errText = "Network error. Please try again.";
        thinkingDiv.dataset.thinking = "0";
        await typeOut(errText, thinkingDiv, 15);

        chatHistory.push({ role: "assistant", content: errText });
        if (chatHistory.length > 10){
          chatHistory = chatHistory.slice(-10);
        }
        saveChatHistory();

      } finally {
        if (sendBtn) sendBtn.disabled = false;
        if (input){
          input.disabled = false;
          input.focus();
        }
        if (spin) spin.classList.add("d-none");
        if (sendLabel) sendLabel.textContent = "Send";
      }
    }

    // ====== Submit Ø§Ù„ÙÙˆØ±Ù… ======
    form?.addEventListener("submit", function(e){
      e.preventDefault();
      const q = (input.value || "").trim();
      if (!q) return;

      appendMsg(q, "user");
      input.value = "";

      if (sendBtn) sendBtn.disabled = true;
      if (input)  input.disabled  = true;

      if (panel && panel.classList.contains("d-none")){
        openPanel();
      }

      sendQuestion(q);
    });

    // ====== Ø£ÙˆÙ„ ØªØ­Ù…ÙŠÙ„: Ø±Ø¬Ù‘Ø¹ Ø§Ù„Ù‡Ø³ØªÙˆØ±ÙŠ Ù…Ù† localStorage Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ ======
    loadChatHistory();

    if (msgsBox && chatHistory.length){
      // ÙÙŠÙ‡ Ù‡Ø³ØªÙˆØ±ÙŠ Ù…Ø­ÙÙˆØ¸ â†’ Ø§Ø¹Ø±Ø¶Ù‡ Ù…ÙƒØ§Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
      msgsBox.innerHTML = "";
      chatHistory.forEach(turn => {
        const who = (turn.role === "user" ? "user" : "assistant");
        appendMsg(turn.content, who, { skipHistory: true });
      });
    } else if (msgsBox){
      // Ù…ÙÙŠØ´ Ù‡Ø³ØªÙˆØ±ÙŠ â†’ Ø®ÙØ¯ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© ÙˆØ§Ø­ÙØ¸Ù‡Ø§ ÙƒØ¨Ø¯Ø§ÙŠØ©
      const initial = msgsBox.querySelector(".ai-msg-bot");
      if (initial && initial.textContent.trim()){
        chatHistory.push({ role: "assistant", content: initial.textContent.trim() });
        saveChatHistory();
      }
    }
  })();
</script>



</body>
</html>
