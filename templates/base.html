<!doctype html>
<html lang="en" dir="ltr">
{% load static %}
<head>
  <meta charset="utf-8">
  <title>{% block title %}Ù…Ù†ØµÙ‘Ø© Ø§Ù„Ø¯Ø±Ø§Ø³Ø©{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root {
      --brand-primary: #3a6ff8;
      --brand-secondary: #4cc9f0;
      --brand-accent: #7209b7;
      --text-light: #ffffff;
      --text-dark: #212529;
      --bg-light: #f7f8fa;
      --bg-white: #ffffff;
      --card-bg: #ffffff;
      --success: #28a745;
      --danger: #dc3545;
      --warning: #ffc107;
      --muted: #6c757d;
      --border-color: #dee2e6;

      --gradient-primary: linear-gradient(45deg, #3a6ff8, #4cc9f0);
      --gradient-secondary: linear-gradient(45deg, #4cc9f0, #7209b7);
      --gradient-card: linear-gradient(to right, #3a6ff8, #4cc9f0);
    }

    body {
      background-color: var(--bg-light);
      font-family: 'sans-serif';
      color: var(--text-dark);
    }

    .app-header {
      background-color: var(--bg-white);
      border-bottom: 1px solid var(--border-color);
    }

    .app-brand {
      color: var(--brand-primary);
      font-weight: 700;
      text-decoration: none;
    }
    .app-brand-logo{
      height: 40px;
      width: auto;
      display: block;
    }

    .app-nav .nav-link {
      color: var(--text-dark);
      font-weight: 500;
      border-radius: 99px; /* Pill shape */
      margin: 0 4px;
      padding: 8px 16px;
    }
    .app-nav .nav-link.active,
    .app-nav .nav-link:hover {
      color: var(--text-light);
      background: var(--gradient-primary);
    }

    .page-title {
      font-size: 1.5rem;
      font-weight: 700;
      text-transform: uppercase;
      color: var(--brand-primary);
      margin-bottom: 0.5rem;
    }
    .page-subtitle {
      font-size: 1rem;
      color: var(--muted);
    }

    .card {
      border: none;
      border-radius: 20px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.07);
      background-color: var(--card-bg);
    }
    .card-gradient {
      background: var(--gradient-card);
      color: var(--text-light);
    }
    .card-gradient .card-title, .card-gradient .card-text, .card-gradient .display-4 {
      color: var(--text-light);
    }

    .btn {
      border-radius: 99px; /* Pill shape */
      font-weight: 700;
      padding: 12px 30px;
      border: none;
      transition: all 0.3s ease;
    }
    .btn-primary {
      background: var(--gradient-primary);
      color: var(--text-light);
    }
    .btn-primary:hover {
      color: var(--text-light);
      box-shadow: 0 10px 20px rgba(58, 111, 248, 0.3);
    }
    .btn-secondary {
      background-color: var(--bg-white);
      color: var(--brand-primary);
      border: 2px solid var(--brand-primary);
    }
    .btn-success { background-color: var(--success); color: var(--text-light); }
    .btn-danger { background-color: var(--danger); color: var(--text-light); }

    .form-control {
      border-radius: 12px;
      padding: 12px 20px;
      border: 1px solid var(--border-color);
    }
    .form-control:focus {
      border-color: var(--brand-primary);
      box-shadow: 0 0 0 0.25rem rgba(58, 111, 248, 0.25);
    }

    /* Floating Action Buttons (old generic, Ù„Ùˆ Ø­Ø§Ø¨Ø¨ ØªØ³ØªØ®Ø¯Ù…Ù‡Ø§ Ù„Ø§Ø­Ù‚Ù‹Ø§) */
    .fab {
      position: fixed;
      z-index: 1040;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 10px 20px rgba(0,0,0,.12);
    }
    .fab img {
      width: 32px;
      height: 32px;
    }

    /* Study FAB icon Ø§Ù„Ø­Ø§Ù„ÙŠ */
    .fab-study-icon{
      width: 24px;
      height: 24px;
      object-fit: contain;
    }

    /* Pomodoro HUD */
    .pomo-hud {
      position: fixed;
      right: 24px;
      bottom: 96px;
      z-index: 1040;
      min-width: 240px;
      background: var(--bg-white);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.07);
    }
    .pomo-time {
      font-size: 1.5rem;
      font-weight: 700;
      letter-spacing: 1px;
      color: var(--brand-primary);
    }

    /* ===== AI Chat styles (Ù†ÙØ³ Ø§Ù„ÙƒÙ„Ø§Ø³Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©) ===== */
    #ai-chat-widget{
      /* Ù†ÙØ³ Ù…ÙƒØ§Ù† Ø§Ù„Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ø§Ø¦Ù… */
      z-index: 1040;
    }

    .ai-chat-btn{
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 999px;
      border: 1px solid var(--border-color);
      background-color: var(--bg-white);
      font-size: 0.9rem;
      font-weight: 600;
      box-shadow: 0 6px 18px rgba(15,23,42,.15);
      cursor: pointer;
    }
    .ai-chat-btn:hover{
      background-color: #eef2ff;
    }

    .ai-chat-icon{
      width: 22px;
      height: 22px;
      object-fit: contain;
    }

    .ai-chat-panel{
      position: absolute;
      left: 0;
      bottom: 56px; /* ÙÙˆÙ‚ Ø§Ù„Ø²Ø±Ø§Ø± Ø´ÙˆÙŠØ© */
      width: 360px;
      max-width: 80vw;
      max-height: 70vh;
      background-color: var(--bg-white);
      border-radius: 18px;
      box-shadow: 0 16px 40px rgba(15,23,42,.25);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      border: 1px solid rgba(148,163,184,.4);
    }

    .ai-chat-header{
      padding: 10px 14px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      background: linear-gradient(90deg,#3a6ff8,#4cc9f0);
      color: #fff;
    }
    .ai-chat-header .small{
      color: rgba(255,255,255,.85)!important;
    }

    .ai-chat-messages{
      padding: 12px;
      background-color: var(--bg-light);
      overflow-y: auto;
      flex: 1;
    }

    .ai-msg{
      padding: 8px 12px;
      border-radius: 16px;
      margin-bottom: 8px;
      font-size: 0.9rem;
      line-height: 1.4;
      max-width: 90%;
      word-wrap: break-word;
    }
    .ai-msg-bot{
      background-color: #ffffff;
      border: 1px solid #e5e7eb;
      margin-right: auto;   /* Ù†Ø§Ø­ÙŠØ© Ø§Ù„Ø´Ù…Ø§Ù„ */
    }
    .ai-msg-user{
      background-color: var(--brand-primary);
      color: #ffffff;
      margin-left: auto;    /* Ù†Ø§Ø­ÙŠØ© Ø§Ù„ÙŠÙ…ÙŠÙ† */
    }

    .ai-chat-form{
      padding: 8px 10px;
      border-top: 1px solid var(--border-color);
      background-color: var(--bg-white);
      display: flex;
      gap: 8px;
    }
    .ai-chat-form .form-control{
      flex: 1;
      padding: 8px 14px;
      border-radius: 999px;
    }
    .ai-chat-form .btn{
      padding: 8px 18px;
      border-radius: 999px;
      font-size: 0.85rem;
    }

    /* Ù…ÙˆØ¨Ø§ÙŠÙ„: Ø®Ù„ÙŠ Ø§Ù„Ø¨Ø§Ù†Ù„ ÙŠØ§Ø®Ø¯ Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø§Ø´Ø© ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§ */
    @media (max-width: 576px){
      #ai-chat-widget{
        left: 12px !important;
        right: 12px !important;
      }
      .ai-chat-panel{
        width: 100%;
        left: 0;
        bottom: 60px;
        max-width: none;
      }
    }
    /* ===== ØªØ­Ø³ÙŠÙ† Ø­Ø¬Ù… Ù†Ø§ÙØ°Ø© Ø§Ù„Ù€ AI chat Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ± Ø§Ù„ÙƒÙ„Ø§Ø³Ø§Øª ===== */
.ai-chat-panel {
  width: 33vw;             /* Ø­ÙˆØ§Ù„Ù‰ ØªÙ„Øª Ø§Ù„Ø´Ø§Ø´Ø© */
  max-width: 480px;        /* Ø£Ù‚ØµÙ‰ Ø¹Ø±Ø¶ */
  max-height: 75vh;        /* Ø£ÙƒØ¨Ø± Ø´ÙˆÙŠØ© Ù…Ù† Ù‚Ø¨Ù„ */
  border-radius: 20px;
  box-shadow: 0 12px 40px rgba(0,0,0,0.25);
}

/* padding Ø¯Ø§Ø®Ù„Ù‰ Ù…Ø±ÙŠØ­ Ø£ÙƒØªØ± */
.ai-chat-messages {
  padding: 16px 20px;
  line-height: 1.6;
}

/* ÙÙ‚Ø§Ø¹Ø§Øª Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
.ai-msg {
  padding: 10px 16px;
  border-radius: 16px;
  margin-bottom: 10px;
  font-size: 0.95rem;
}

/* ===== Ø§Ù„Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ø§Ø¦Ù… ÙˆØ£ÙŠÙ‚ÙˆÙ†Ø© AI ===== */
/* Ø²Ø± Ask AI â€“ Ø®Ù„ÙÙŠØ© Ø¬radient Ø¹Ù„Ø´Ø§Ù† Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© ØªØ¨Ø§Ù† */
.ai-chat-btn{
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 10px 18px;
  border-radius: 999px;
  border: none;
  background: var(--gradient-primary);  /* Ø§Ù„Ø£Ø²Ø±Ù‚/ØªØ±ÙƒÙˆØ§Ø² */
  color: #ffffff;
  font-size: 0.9rem;
  font-weight: 600;
  box-shadow: 0 8px 20px rgba(15,23,42,.25);
  cursor: pointer;
}

.ai-chat-btn:hover{
  filter: brightness(1.05);
}

/* Ø­Ø¬Ù… Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© */
.ai-chat-icon{
  width: 26px;
  height: 26px;
  object-fit: contain;
}


/* ===== Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ ===== */
@media (max-width: 768px) {
  .ai-chat-panel {
    width: 90%;
    left: 5%;
    bottom: 80px;
    max-height: 70vh;
  }
}

    .htmx-indicator { display: none; }
    .htmx-request .htmx-indicator,
    .htmx-request.htmx-indicator { display: inline-block; }
  </style>

  {% block extra_head %}{% endblock %}
</head>
<body>

<header class="app-header">
  <div class="container py-2 d-flex align-items-center justify-content-between">
    {% include "_partials/_header.html" %}
  </div>
  <div class="border-top">
    <div class="container">
      {% include "_partials/_nav.html" %}
    </div>
  </div>
</header>

<main class="container py-3">
  {% block content %}{% endblock %}
</main>

<footer class="mt-5">
  <div class="container py-4 text-center text-muted">
    {% include "_partials/_footer.html" %}
  </div>
</footer>

{% block extra_js %}{% endblock %}



{% if request.session.access %}
<!-- Study Modal -->
<div class="modal fade" id="pomodoroModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0">
      <div class="modal-header">
        <h5 class="modal-title">Select Study Time</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div class="mb-2 small text-muted">ğŸŒ³ Each 25 min builds a tree</div>

        <div class="input-group mb-3" style="max-width: 300px;">
          <span class="input-group-text">â±</span>
          <select id="pomodoro-duration" class="form-select">
            <option value="20">min 20</option>
            <option value="25" selected>min 25</option>
            <option value="30">min 30</option>
            <option value="40">min 40</option>
          </select>
          <span class="input-group-text">ğŸ•‘</span>
        </div>

        <div id="pomodoro-ticker" class="display-4 fw-semibold text-center my-3" style="letter-spacing:2px;">
          25:00
        </div>

        <div class="d-flex gap-2">
          <button id="pomodoro-stop"  class="btn btn-outline-secondary flex-fill" disabled>Stop</button>
          <button id="pomodoro-start" class="btn btn-primary flex-fill">Start Now</button>
        </div>

        <div id="pomodoro-msg" class="alert alert-secondary mt-3 d-none">â€”</div>
      </div>
    </div>
  </div>
</div>

<!-- Congrats -->
<div class="modal fade" id="pomodoroDone" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 text-center">
      <div class="modal-body p-4">
        <div class="display-5 mb-2">ğŸŒ³</div>
        <h5 class="mb-1">Congratulations</h5>
        <div class="text-muted mb-3">You have built a tree!</div>
        <div class="d-flex gap-2 justify-content-center">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Take Rest</button>
          <button class="btn btn-primary" data-bs-dismiss="modal" data-bs-toggle="modal" data-bs-target="#pomodoroModal">Study More</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Floating Study button (big) -->
<button id="fabStudy"
        class="btn btn-primary rounded-pill fab-pomo d-flex align-items-center gap-2"
        style="position: fixed; right: 24px; bottom: 24px; z-index: 1040;"
        data-bs-toggle="modal"
        data-bs-target="#pomodoroModal">
  <img src="{% static 'logos/study.png' %}" alt="Study" class="fab-study-icon">
  <span id="fabStudyLabel">Study 25 mins</span>
</button>


<!-- HUD -->
<div id="pomoHUD" class="pomo-hud d-none">
  <div class="card shadow-sm border-0">
    <div class="card-body d-flex align-items-center justify-content-between gap-2">
      <div class="pomo-time fw-bold" id="pomoHUDTime">25:00</div>
      <div class="btn-group btn-group-sm">
        <button id="pomoHUDPause"  class="btn btn-outline-secondary">Pause</button>
        <button id="pomoHUDResume" class="btn btn-outline-secondary d-none">Resume</button>
        <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#pomodoroModal">â‹¯</button>
        <button id="pomoHUDStop"   class="btn btn-outline-danger">Stop</button>
      </div>
    </div>
  </div>
</div>

<!-- ===== AI Chat floating widget ===== -->
<div id="ai-chat-widget" style="position: fixed; bottom: 24px; left: 24px; z-index: 1040;">
  <!-- Ø§Ù„Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ø§Ø¦Ù… -->
  <button type="button" id="aiChatToggle" class="ai-chat-btn">
    <img src="{% static 'logos/ai.png' %}" alt="AI" class="ai-chat-icon">
    <span>Ask AI</span>
  </button>

  <!-- Ø§Ù„Ø¨Ø§Ù†Ù„ -->
  <div id="ai-chat-panel" class="ai-chat-panel d-none">
    <div class="ai-chat-header">
      <div>
        <div class="fw-semibold">Axonelix AI tutor</div>
        <div class="small text-muted">Ask about your materials & questions</div>
      </div>
      <button type="button" class="btn-close btn-sm" id="ai-chat-close" aria-label="Close"></button>
    </div>

    <div id="ai-chat-messages" class="ai-chat-messages">
      <div class="ai-msg ai-msg-bot">
        ğŸ‘‹ Hi! Ask me anything about your medical materials or questions.
      </div>
    </div>

    <form id="ai-chat-form" class="ai-chat-form">
      {% csrf_token %}
      <input
        id="ai-chat-input"
        type="text"
        class="form-control form-control-sm"
        placeholder="Type your question and press Enter..."
        autocomplete="off"
      >
      <button class="btn btn-primary btn-sm" type="submit" id="ai-chat-send">
        <span class="spinner-border spinner-border-sm d-none" id="ai-chat-spin" role="status"></span>
        <span id="ai-chat-send-label">Send</span>
      </button>
    </form>
  </div>
</div>
{% endif %}
<!-- JS: Bootstrap Bundle + HTMX -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/htmx.org@1.9.12"></script>
<script>
  // ====== CSRF once ======
  function getCookie(name){const m=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)');return m?m.pop():''}
  document.body.addEventListener('htmx:configRequest', e => { e.detail.headers['X-CSRFToken']=getCookie('csrftoken'); });

  // ====== Elements (modal + HUD) ======
  const durSel   = document.getElementById('pomodoro-duration');
  const ticker   = document.getElementById('pomodoro-ticker');
  const btnStart = document.getElementById('pomodoro-start');
  const btnStop  = document.getElementById('pomodoro-stop');
  const msg      = document.getElementById('pomodoro-msg');
  const modalEl  = document.getElementById('pomodoroModal');
  const fab      = document.getElementById('fabStudy');
  const fabLabel = document.getElementById('fabStudyLabel');

  const hud      = document.getElementById('pomoHUD');
  const hudTime  = document.getElementById('pomoHUDTime');
  const hudPause = document.getElementById('pomoHUDPause');
  const hudResume= document.getElementById('pomoHUDResume');
  const hudStop  = document.getElementById('pomoHUDStop');

  // ====== Persistent state in localStorage ======
  const STORAGE_KEY = 'pomo_state_v1';

  // state schema:
  // {
  //   running: bool, paused: bool,
  //   total: seconds, started_ms: epoch_ms,
  //   paused_accum: seconds,     // Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ØªÙˆÙ‚ÙØ§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
  //   paused_start_ms: epoch_ms|null  // Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªÙˆÙ‚Ù Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ùˆ paused=true
  // }
  let state = {
    running:false, paused:false,
    total: 25*60,
    started_ms: null,
    paused_accum: 0,
    paused_start_ms: null,
    timer_id: null,
  };

  const fmt = s => { s=Math.max(0,Math.floor(s)); const m=Math.floor(s/60), ss=s%60; return `${String(m).padStart(2,'0')}:${String(ss).padStart(2,'0')}`; };
  const setFabLabel = mins => {
    if (fabLabel) fabLabel.textContent = `Study ${mins} mins`;
  };

  function saveState(){
    const toSave = {
      running: state.running,
      paused: state.paused,
      total: state.total,
      started_ms: state.started_ms,
      paused_accum: state.paused_accum,
      paused_start_ms: state.paused_start_ms
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(toSave));
  }

  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      const s = JSON.parse(raw);
      // validate
      if (typeof s.total !== 'number' || !s.started_ms) return;
      state.running = !!s.running;
      state.paused  = !!s.paused;
      state.total   = s.total;
      state.started_ms = s.started_ms;
      state.paused_accum = s.paused_accum || 0;
      state.paused_start_ms = s.paused_start_ms || null;
    }catch(_){}
  }

  function nowMs(){ return Date.now(); }

  // remaining seconds based on wall clock
  function remainingSeconds(){
    if (!state.started_ms) return state.total;
    const now = nowMs();
    const pausedExtra = state.paused && state.paused_start_ms ? Math.max(0, Math.floor((now - state.paused_start_ms)/1000)) : 0;
    const pausedTotal = state.paused_accum + pausedExtra;
    const elapsed = Math.max(0, Math.floor((now - state.started_ms)/1000) - pausedTotal);
    return state.total - elapsed;
  }

  function showHUD(){
    hud.classList.remove('d-none');
    hudPause.classList.toggle('d-none', state.paused || !state.running);
    hudResume.classList.toggle('d-none', !state.paused);
  }
  function hideHUD(){ hud.classList.add('d-none'); }

  function render(){
    const left = remainingSeconds();
    if (ticker)  ticker.textContent  = fmt(left);
    if (hudTime) hudTime.textContent = fmt(left);
  }

  function startInterval(){
    if (state.timer_id) return;
    state.timer_id = setInterval(()=>{
      render();
      const left = remainingSeconds();
      if (left <= 0){
        clearInterval(state.timer_id); state.timer_id=null;
        // complete
        const minutes = Math.round(state.total/60);
        const startedISO = new Date(state.started_ms).toISOString();
        resetRunning(false); // don't log elapsed again here
        postSession(minutes, startedISO, true);
      }
    }, 1000);
  }
  function stopInterval(){ if (state.timer_id){ clearInterval(state.timer_id); state.timer_id=null; } }

  function resetRunning(keepUI=false){
    stopInterval();
    state.running=false; state.paused=false;
    state.started_ms=null; state.paused_accum=0; state.paused_start_ms=null;
    saveState();
    hideHUD();
    if (!keepUI){
      // Ù„Ø§ ØªØºÙŠÙ‘Ø± Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±ØŒ ÙÙ‚Ø· Ø£Ø¹ÙØ¯ Ø§Ù„Ø¹Ø±Ø¶ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
      const mins = parseInt(durSel?.value || String(Math.round(state.total/60)), 10) || 25;
      state.total = mins*60;
      render();
    }
  }

  // ====== Session actions ======
  function startSession(){
    if (state.running) return;
    const mins = parseInt(durSel.value || '25', 10);
    state.total = mins*60;
    state.started_ms = nowMs();
    state.paused_accum = 0;
    state.paused_start_ms = null;
    state.running = true; state.paused = false;
    saveState();
    showHUD();
    render();
    startInterval();
  }

  function pauseSession(){
    if (!state.running || state.paused) return;
    state.paused = true;
    state.paused_start_ms = nowMs();
    saveState();
    showHUD();
    render();
  }

  function resumeSession(){
    if (!state.running || !state.paused) return;
    // Ø£Ø¶ÙÙ Ù…Ø¯Ø© Ø§Ù„ØªÙˆÙ‚Ù Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¬Ù…Ø¹
    const now = nowMs();
    if (state.paused_start_ms) {
      state.paused_accum += Math.max(0, Math.floor((now - state.paused_start_ms)/1000));
    }
    state.paused = false;
    state.paused_start_ms = null;
    saveState();
    showHUD();
    render();
  }

  function stopSession(logElapsed=true){
    if (!state.started_ms){ resetRunning(); return; }
    // Ø§Ø­Ø³Ø¨ Ø§Ù„Ù…Ù†Ù‚Ø¶ÙŠ Ø§Ù„ÙØ¹Ù„ÙŠ
    const left = remainingSeconds();
    const elapsedMin = Math.max(0, Math.round((state.total - left)/60));
    const startedISO = new Date(state.started_ms).toISOString();
    resetRunning();
    if (logElapsed && elapsedMin >= 1){
      postSession(elapsedMin, startedISO, false);
    }
  }

  // ====== UI bindings ======
  function updateForSelect(){
    const mins = parseInt(durSel.value || '25', 10);
    setFabLabel(mins);
    if (!state.running){
      state.total = mins*60;
      render();
    }
  }
  if (durSel) durSel.addEventListener('change', updateForSelect);

  if (btnStart) btnStart.addEventListener('click', ()=>{
    if (!state.running) startSession();
    if (window.bootstrap) bootstrap.Modal.getOrCreateInstance(modalEl).hide();
  });

  if (btnStop) btnStop.addEventListener('click', ()=> stopSession(true));

  if (hudPause)  hudPause.addEventListener('click', pauseSession);
  if (hudResume) hudResume.addEventListener('click', resumeSession);
  if (hudStop)   hudStop.addEventListener('click', ()=> stopSession(true));

  if (modalEl){
    modalEl.addEventListener('show.bs.modal', ()=>{
      // Ø§Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
      if (state.running){
        // Ø§Ø¶Ø¨Ø· select Ø¹Ù„Ù‰ Ù…Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        const m = String(Math.round(state.total/60));
        if (durSel && durSel.value !== m) durSel.value = m;
        btnStart.disabled = true; btnStop.disabled = false;
      }else{
        btnStart.disabled = false; btnStop.disabled = true;
      }
      render();
    });
    modalEl.addEventListener('hidden.bs.modal', ()=>{ if (state.running) showHUD(); });
  }

  window.addEventListener('beforeunload', saveState);

  // ====== API call ======
  async function postSession(minutes, startedISO, showCongrats){
    try{
      const res = await fetch("{% url 'pomodoro_log' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
          "X-CSRFToken": getCookie("csrftoken"),
        },
        body: new URLSearchParams({minutes:String(minutes), started_at: startedISO}),
      });
      const js = await res.json();
      if (js.ok){
        // Ø­Ø¯Ù‘Ø« Ø¹Ø¯Ù‘Ø§Ø¯Ø§Øª Ø§Ù„ØµÙØ­Ø© Ø¥Ù† ÙˆØ¬Ø¯Øª
        try{
          const elMin=document.getElementById('study-today-min');
          const elTrees=document.getElementById('trees-today');
          if (elMin){
            const newMin=(parseInt(elMin.textContent||'0',10)+minutes);
            elMin.textContent=String(newMin);
            if (elTrees) elTrees.textContent=String(Math.floor(newMin/25));
          }
        }catch(_){}
        if (showCongrats && window.bootstrap){
          bootstrap.Modal.getOrCreateInstance(document.getElementById('pomodoroDone')).show();
        }
      }
    }catch(e){ console.warn('pomodoro_log error', e); }
  }

  // ====== Restore & boot ======
  (function boot(){
    // Ø§Ø¶Ø¨Ø· Ù„Ø§Ø¨Ù„ Ø§Ù„Ø²Ø± (25 Ø§ÙØªØ±Ø§Ø¶ÙŠ)
    setFabLabel(25);
    // Ø­Ù…Ù‘Ù„ Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ùˆ ÙÙŠ Ø¬Ù„Ø³Ø© Ù‚Ø§Ø¦Ù…Ø©
    loadState();

    // Ù„Ùˆ Ø§Ù„Ø¬Ù„Ø³Ø© Ù‚Ø§Ø¦Ù…Ø©ØŒ Ø§Ø³ØªØ£Ù†Ù ÙÙˆØ±Ù‹Ø§
    if (state.running){
      showHUD();
      render();
      startInterval();
      // Ø§Ø¶Ø¨Ø· Ù„Ø§Ø¨Ù„ Ø§Ù„Ø²Ø± Ø¹Ù„Ù‰ Ù…Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø©
      setFabLabel(Math.round(state.total/60));
    }else{
      // Ø§Ø³ØªØ®Ø¯Ù… Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠØ©
      const mins = parseInt(durSel?.value || '25', 10);
      state.total = mins*60;
      render();
      setFabLabel(mins);
    }
  })();
</script>

<!-- ===== AI Chat JS ===== -->
<script>
  (function(){
    const toggleBtn = document.getElementById("aiChatToggle");
    const panel     = document.getElementById("ai-chat-panel");
    const closeBtn  = document.getElementById("ai-chat-close");
    const form      = document.getElementById("ai-chat-form");
    const input     = document.getElementById("ai-chat-input");
    const msgsBox   = document.getElementById("ai-chat-messages");
    const sendBtn   = document.getElementById("ai-chat-send");
    // Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ† Ø¨Ø³ Ù…Ø´ Ø¨Ù†Ø³ØªØ®Ø¯Ù…Ù‡Ù… ÙƒÙ€ indicator Ø¯Ù„ÙˆÙ‚ØªÙ‰
    const spin      = document.getElementById("ai-chat-spin");
    const sendLabel = document.getElementById("ai-chat-send-label");

    // ====== ØªØ®Ø²ÙŠÙ† Ù…Ø­Ù„Ù‰ Ù„Ù„Ù‡Ø³ØªÙˆØ±ÙŠ ======
    const AI_STORAGE_KEY = "ax_ai_chat_history_v1";
    let chatHistory = [];

    function saveChatHistory(){
      try {
        localStorage.setItem(AI_STORAGE_KEY, JSON.stringify(chatHistory));
      } catch(e) {
        // ignore
      }
    }

    function loadChatHistory(){
      try {
        const raw = localStorage.getItem(AI_STORAGE_KEY);
        if (!raw) return;
        const arr = JSON.parse(raw);
        if (Array.isArray(arr)){
          chatHistory = arr.slice(-10);
        }
      } catch(e) {
        // ignore
      }
    }

    // ====== ÙØªØ­/ØºÙ„Ù‚ Ø§Ù„Ø¨Ø§Ù†Ù„ ======
    function openPanel(){
      if (!panel) return;
      panel.classList.remove("d-none");
      setTimeout(()=> input && input.focus(), 50);
    }
    function closePanel(){
      if (!panel) return;
      panel.classList.add("d-none");
    }

    toggleBtn?.addEventListener("click", function(){
      if (!panel) return;
      if (panel.classList.contains("d-none")) openPanel();
      else closePanel();
    });
    closeBtn?.addEventListener("click", closePanel);

    // ====== Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ù€ UI + ØªØ­Ø¯ÙŠØ« history ======
    function appendMsg(text, who, opts){
      opts = opts || {};
      const div = document.createElement("div");
      div.className = "ai-msg " + (who === "user" ? "ai-msg-user" : "ai-msg-bot");
      if (opts.thinking){
        div.dataset.thinking = "1";
      }
      div.textContent = text;
      msgsBox.appendChild(div);
      msgsBox.scrollTop = msgsBox.scrollHeight;

      // Ù…Ø§ Ù†Ø¶ÙŠÙØ´ thinking / Ø±Ø³Ø§Ø¦Ù„ Ù…Ø¹ÙŠÙ†Ø© Ù„Ù„Ù‡Ø³ØªÙˆØ±ÙŠ Ù„Ùˆ skipHistory=true
      if (!opts.skipHistory && !opts.thinking){
        chatHistory.push({
          role: (who === "user" ? "user" : "assistant"),
          content: text
        });
        if (chatHistory.length > 10){
          chatHistory = chatHistory.slice(-10);
        }
        saveChatHistory();
      }
      return div;
    }

    // ====== ØªØ£Ø«ÙŠØ± Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¨Ø·ÙŠØ¦Ø© ======
    function typeOut(text, el, speed){
      return new Promise(resolve => {
        let i = 0;
        el.textContent = "";
        function step(){
          if (i >= text.length){
            return resolve();
          }
          el.textContent += text[i];
          i++;
          if (msgsBox){
            msgsBox.scrollTop = msgsBox.scrollHeight;
          }
          setTimeout(step, speed);
        }
        step();
      });
    }

    // ====== Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù„Ù„Ø¨Ø§Ùƒ + thinking bubble ======
    async function sendQuestion(q){
      // bubble "Thinking..." Ø¯Ø§Ø®Ù„ Ø§Ù„Ø´Ø§Øª
      const thinkingDiv = appendMsg("Thinkingâ€¦", "bot", {
        thinking: true,
        skipHistory: true
      });

      try{
        const res = await fetch("{% url 'web_ai_ask' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
            "X-CSRFToken": getCookie("csrftoken"),
          },
          body: new URLSearchParams({
            q: q,
            history: JSON.stringify(chatHistory)   // ØªÙ…Ø±ÙŠØ± Ø¢Ø®Ø± 10 Ø±Ø³Ø§Ø¦Ù„ Ù„Ù„Ø¨Ø§Ùƒ
          })
        });

        const js = await res.json();
        let answerText;
        if (js.answer){
          answerText = js.answer;
        } else if (js.error){
          answerText = js.error;
        } else {
          answerText = "Something went wrong.";
        }

        thinkingDiv.dataset.thinking = "0";
        await typeOut(answerText, thinkingDiv, 15);

        // Ø¶ÙŠÙ Ø§Ù„Ø±Ø¯ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù„Ù„Ù‡Ø³ØªÙˆØ±ÙŠ Ø¨Ø¹Ø¯ Ù…Ø§ ÙŠØ®Ù„Øµ ÙƒØªØ§Ø¨Ø©
        chatHistory.push({ role: "assistant", content: answerText });
        if (chatHistory.length > 10){
          chatHistory = chatHistory.slice(-10);
        }
        saveChatHistory();

      } catch(e){
        const errText = "Network error. Please try again.";
        thinkingDiv.dataset.thinking = "0";
        await typeOut(errText, thinkingDiv, 15);

        chatHistory.push({ role: "assistant", content: errText });
        if (chatHistory.length > 10){
          chatHistory = chatHistory.slice(-10);
        }
        saveChatHistory();

      } finally {
        if (sendBtn) sendBtn.disabled = false;
        if (input){
          input.disabled = false;
          input.focus();
        }
        if (spin) spin.classList.add("d-none");
        if (sendLabel) sendLabel.textContent = "Send";
      }
    }

    // ====== Submit Ø§Ù„ÙÙˆØ±Ù… ======
    form?.addEventListener("submit", function(e){
      e.preventDefault();
      const q = (input.value || "").trim();
      if (!q) return;

      appendMsg(q, "user");
      input.value = "";

      if (sendBtn) sendBtn.disabled = true;
      if (input)  input.disabled  = true;

      if (panel && panel.classList.contains("d-none")){
        openPanel();
      }

      sendQuestion(q);
    });

    // ====== Ø£ÙˆÙ„ ØªØ­Ù…ÙŠÙ„: Ø±Ø¬Ù‘Ø¹ Ø§Ù„Ù‡Ø³ØªÙˆØ±ÙŠ Ù…Ù† localStorage Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ ======
    loadChatHistory();

    if (msgsBox && chatHistory.length){
      // ÙÙŠÙ‡ Ù‡Ø³ØªÙˆØ±ÙŠ Ù…Ø­ÙÙˆØ¸ â†’ Ø§Ø¹Ø±Ø¶Ù‡ Ù…ÙƒØ§Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
      msgsBox.innerHTML = "";
      chatHistory.forEach(turn => {
        const who = (turn.role === "user" ? "user" : "assistant");
        appendMsg(turn.content, who, { skipHistory: true });
      });
    } else if (msgsBox){
      // Ù…ÙÙŠØ´ Ù‡Ø³ØªÙˆØ±ÙŠ â†’ Ø®ÙØ¯ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© ÙˆØ§Ø­ÙØ¸Ù‡Ø§ ÙƒØ¨Ø¯Ø§ÙŠØ©
      const initial = msgsBox.querySelector(".ai-msg-bot");
      if (initial && initial.textContent.trim()){
        chatHistory.push({ role: "assistant", content: initial.textContent.trim() });
        saveChatHistory();
      }
    }
  })();
</script>



</body>
</html>
