{% extends "base.html" %}
{% load static %}
{% block title %}Instapay Payment · Axonelix{% endblock %}

{% block extra_head %}
<style>
  .pay-hero {
    border-radius: 20px;
    background: linear-gradient(120deg, rgba(58,111,248,.12), rgba(76,201,240,.10));
    border: 1px solid var(--border-color);
    padding: 18px;
    box-shadow: 0 12px 28px rgba(15,23,42,.06);
  }
  .pay-brand { display: inline-flex; align-items: center; gap: 10px; }
  .pay-brand img { height: 28px; width: auto; }
  .pay-title { font-weight: 800; color: var(--brand-primary); }
  .price-box .base { font-size: 1.25rem; font-weight: 700; }
  .price-box .disc { font-size: 1.25rem; font-weight: 700; color: #16a34a; }
  .chip { display:inline-flex; align-items:center; gap:6px; padding:6px 12px; border-radius:999px;
          border:1px solid var(--border-color); background: var(--bg-white); color: var(--muted); font-weight:600; }
  .steps { display:grid; grid-template-columns: 1fr; gap: 8px; }
  .step { display:flex; align-items:flex-start; gap:10px; }
  .step .icon { font-size: 1.1rem; }
  .qr-box { border:1px dashed var(--border-color); border-radius:16px; padding:10px; display:flex; align-items:center; justify-content:center; }
  .muted { color: var(--muted); }
</style>
{% endblock %}

{% block content %}
<div class="container py-4" style="max-width: 820px;">

  <!-- Hero -->
  <div class="pay-hero mb-3">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
      <div class="d-flex align-items-center gap-3">
        <div class="pay-brand">
          <img src="{% static 'logos/instapay.png' %}" alt="Instapay">
          <span class="pay-title">Instapay Payment</span>
        </div>
      </div>
      <div class="d-flex align-items-center gap-2">
        <a href="{{ instapay_link }}" target="_blank" rel="noopener" class="btn btn-primary btn-sm">Open Instapay</a>
        <button class="btn btn-outline-primary btn-sm" type="button" id="copy-link-btn">Copy Link</button>
        <a href="{% url 'web_plans' %}" class="btn btn-light btn-sm">Back to plans</a>
      </div>
    </div>
    <div class="d-flex align-items-center justify-content-between mt-2 flex-wrap gap-2">
      <div class="chip">
        Plan: <strong class="ms-1">
          {% if payment %}{{ payment.plan }}{% else %}{{ plan.name }}{% endif %}
        </strong>
      </div>
      <div class="price-box">
        <span id="base-price" class="base">{{ plan.price_egp }} EGP</span>
        <span id="discounted-price" class="disc d-none"></span>
      </div>
    </div>
    {% if submitted and payment %}
      <div class="alert alert-warning mt-2 mb-0">
        <div>Payment status: <strong>{{ payment.status|title }}</strong></div>
        <div class="small muted mt-1">We’re verifying your transfer. Your subscription activates once confirmed.</div>
      </div>
    {% else %}
      <div class="small muted mt-2">Complete your transfer through Instapay, then confirm below.</div>
    {% endif %}
  </div>

  <!-- Transfer details -->
  <div class="card-soft p-4 mb-3">
    <div class="row g-3">
      <div class="col-md-6">
        <div class="mb-2">
          <div class="small muted mb-1">Pay using Instapay</div>
          <a href="{{ instapay_link }}" target="_blank"
             class="btn btn-outline-primary btn-sm d-flex align-items-center justify-content-center gap-2 w-100">
            <img src="{% static 'logos/instapay.png' %}" alt="Instapay" style="height: 26px;">
            <span>Open Instapay Link</span>
          </a>
          <small class="small muted d-block mt-1">
            You will be redirected to the merchant’s Instapay account.
          </small>
        </div>

        <div class="mb-2">
          <div class="small muted mb-1">Notes code (write in Instapay Notes)</div>
          <div class="input-group input-group-sm">
            {% if payment %}
              <input type="text" class="form-control fw-semibold" value="{{ payment.notes_code }}" readonly>
            {% else %}
              <input type="text" id="notes-code-text" class="form-control fw-semibold" readonly>
            {% endif %}
            <button class="btn btn-outline-secondary" type="button" id="copy-notes-btn">Copy</button>
          </div>
          <small class="small muted mt-1 d-block">
            Paste this code exactly in the <strong>“Notes”</strong> field on Instapay.
          </small>
        </div>
      </div>

      <div class="col-md-6">
        <div class="qr-box">
          <img alt="Instapay QR"
               style="height: 140px; width: 140px;"
               src="https://api.qrserver.com/v1/create-qr-code/?size=140x140&data={{ instapay_link|urlencode }}">
        </div>
        <div class="small muted mt-2 text-center">
          Scan to open Instapay on mobile.
        </div>
      </div>
    </div>

    {% if not submitted %}
      <!-- Coupon -->
      <div class="border rounded-3 p-3 mt-3 bg-light-subtle">
        <div class="row g-3 align-items-end">
          <div class="col-md-6">
            <label class="form-label small mb-1">Have a coupon? (optional)</label>
            <form id="coupon-form" class="d-flex gap-2">
              <input type="text" id="coupon-code-input"
                     class="form-control form-control-sm"
                     placeholder="Enter coupon code">
              <button class="btn btn-outline-secondary btn-sm" type="submit">Apply</button>
            </form>
          </div>
          <div class="col-md-6">
            <div id="coupon-result" class="small muted">
              <!-- Coupon result message -->
            </div>
          </div>
        </div>
      </div>
    {% endif %}

    <!-- Steps -->
    <div class="border rounded-3 p-3 mt-3">
      <div class="small fw-semibold mb-2">How it works</div>
      <div class="steps">
        <div class="step"><span class="icon">1️⃣</span><div>Click <strong>Open Instapay</strong> to go to the merchant account.</div></div>
        <div class="step"><span class="icon">2️⃣</span><div>Transfer the required amount.</div></div>
        <div class="step"><span class="icon">3️⃣</span><div>In Instapay <strong>Notes</strong>, write the code shown above.</div></div>
        <div class="step"><span class="icon">4️⃣</span><div>After the transfer, fill the <strong>confirmation form</strong> below.</div></div>
      </div>
    </div>
  </div>

  <!-- Confirmation -->
  {% if not submitted %}
    <div class="card-soft p-4">
      <h6 class="mb-3">Confirm your transfer</h6>
      <p class="small muted mb-3">Provide transfer details to speed up verification.</p>

      <form method="post" action="{% url 'web_payment_confirm' %}">
        {% csrf_token %}
        <input type="hidden" name="plan_code" value="{{ plan.code }}">
        <input type="hidden" id="notes-code-input" name="notes_code" value="">
        <input type="hidden" id="final-price-input" name="final_price" value="{{ plan.price_egp }}">

        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label small">Instapay reference number <span class="text-danger">*</span></label>
            <input name="reference_no" class="form-control form-control-sm" required placeholder="e.g. 1234567890">
          </div>
          <div class="col-md-4">
            <label class="form-label small">Amount (EGP)</label>
            <input id="amount-input" name="amount_egp" type="number" step="0.01" class="form-control form-control-sm" value="{{ plan.price_egp }}">
          </div>
          <div class="col-md-4">
            <label class="form-label small">Transfer time</label>
            <input name="transfer_at" type="datetime-local" class="form-control form-control-sm">
          </div>
          <div class="col-12">
            <label class="form-label small">Note (optional)</label>
            <input name="note" class="form-control form-control-sm" placeholder="Any extra details about the transfer">
          </div>
        </div>

        <div class="d-flex gap-2 mt-3">
          <button class="btn btn-primary btn-sm" type="submit">Submit confirmation</button>
          <a href="{% url 'web_profile' %}" class="btn btn-light btn-sm">Back to profile</a>
        </div>
      </form>
    </div>
  {% else %}
    <div class="text-end">
      <a href="{% url 'web_profile' %}" class="btn btn-light btn-sm">Back to profile</a>
    </div>
  {% endif %}

</div>
{% endblock %}

{% block extra_js %}
<script>
  function copyText(text) { if (!text) return; navigator.clipboard.writeText(text).catch(()=>{}); }

  document.addEventListener("DOMContentLoaded", function () {
    const copyLinkBtn = document.getElementById("copy-link-btn");
    if (copyLinkBtn) copyLinkBtn.addEventListener("click", () => copyText("{{ instapay_link }}"));

    const copyNotesBtn = document.getElementById("copy-notes-btn");
    const notesText = document.getElementById("notes-code-text");
    if (copyNotesBtn) copyNotesBtn.addEventListener("click", () => copyText(notesText ? notesText.value : ""));

    {% if not submitted %}
      // Generate notes code for new confirmation
      const hiddenNotes = document.getElementById("notes-code-input");
      if (hiddenNotes && !hiddenNotes.value) {
        let code;
        if (window.crypto && window.crypto.randomUUID) {
          code = window.crypto.randomUUID().slice(0, 8);
        } else {
          code = Math.random().toString(36).substring(2, 10).toUpperCase();
        }
        hiddenNotes.value = code;
        if (notesText) notesText.value = code;
      }

      // Coupon handling
      const couponForm = document.getElementById("coupon-form");
      if (couponForm) {
        couponForm.addEventListener("submit", function (e) {
          e.preventDefault();
          const codeInput = document.getElementById("coupon-code-input");
          const resBox = document.getElementById("coupon-result");
          const basePriceEl = document.getElementById("base-price");
          const discountedEl = document.getElementById("discounted-price");
          const amountInput = document.getElementById("amount-input");
          const finalPriceInput = document.getElementById("final-price-input");
          const code = (codeInput.value || "").trim();
          if (!code) { resBox.textContent = "Please enter a coupon code."; resBox.className = "small text-danger"; return; }
          resBox.textContent = "Checking coupon..."; resBox.className = "small muted";
          const url = "{% url 'web_coupon_validate' %}?code=" + encodeURIComponent(code) + "&plan_code={{ plan.code|urlencode }}";
          fetch(url)
            .then(r => r.json())
            .then(data => {
              if (!data.ok) { resBox.textContent = data.message || "Error validating coupon."; resBox.className = "small text-danger"; return; }
              if (!data.valid) {
                resBox.textContent = data.message || "Invalid or expired coupon."; resBox.className = "small text-danger";
                discountedEl.classList.add("d-none"); basePriceEl.classList.remove("text-decoration-line-through", "text-muted");
                amountInput.value = "{{ plan.price_egp }}"; finalPriceInput.value = "{{ plan.price_egp }}";
              } else {
                const newPrice = data.discounted_price || "{{ plan.price_egp }}";
                resBox.textContent = "Coupon applied! New price: " + newPrice + " EGP"; resBox.className = "small text-success";
                basePriceEl.classList.add("text-decoration-line-through", "text-muted");
                discountedEl.textContent = newPrice + " EGP"; discountedEl.classList.remove("d-none");
                amountInput.value = newPrice; finalPriceInput.value = newPrice;
              }
            })
            .catch(() => { resBox.textContent = "Network error."; resBox.className = "small text-danger"; });
        });
      }
    {% endif %}
  });
</script>
{% endblock %}
