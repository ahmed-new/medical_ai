{% extends "base.html" %}
{% block title %}Lesson ¬∑ Axonelix{% endblock %}

{% block extra_head %}
<style>
  .lesson-header { border-radius: 16px; box-shadow: 0 12px 28px rgba(15,23,42,.07); }
  .lesson-title { font-weight: 800; font-size: 1.25rem; color: var(--brand-primary); }
  .meta { display:flex; flex-wrap:wrap; gap:8px; }
  .meta-chip {
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:4px 10px;
    border-radius:999px;
    font-weight:600;
    border:1px solid var(--border-color);
    background: var(--bg-white);
    color: var(--muted);
  }
  .meta-chip.primary { color: var(--brand-primary); border-color: var(--brand-primary); }
  .lesson-actions .btn, .lesson-actions span { display:inline-flex; align-items:center; }
  .reading-progress { position: sticky; top: 0; height: 3px; background: rgba(0,0,0,.06); border-radius: 999px; overflow: hidden; }
  .reading-progress .bar { height: 100%; width: 0%; background: var(--brand-primary); transition: width .12s ease; }
  .nav-tabs .nav-link { font-weight: 600; }

  /* === Full-width mode for lesson content === */
  #lesson-layout.lesson-fullscreen > .col-lg-8 {
    flex: 0 0 100%;
    max-width: 100%;
  }
  #lesson-layout.lesson-fullscreen > .col-lg-4 {
    display: none;
  }
</style>
{% endblock %}

{% block content %}
<div class="lesson-header card-soft p-3 mb-3">
  <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
    <div class="d-flex align-items-center gap-2">
      {% if subject_id %}
        <a href="{% url 'web_materials_home' %}?subject={{ subject_id }}" class="btn btn-outline-secondary btn-sm">‚Üê Back</a>
      {% else %}
        <a href="{% url 'web_materials_home' %}" class="btn btn-outline-secondary btn-sm">‚Üê Back</a>
      {% endif %}
      <div class="lesson-title">{{ lesson.title|default:"Lesson" }}</div>
    </div>
    <div class="d-flex align-items-center gap-2 lesson-actions">
      <span id="done-{{ lesson_id }}">
        {% include "components/_lesson_done_button.html" with lesson_id=lesson_id is_done=is_done %}
      </span>
      <span id="fav-{{ lesson_id }}">
        {% include "components/_favorite_button.html" with lesson_id=lesson_id is_fav=is_fav %}
      </span>
      <a class="btn btn-outline-primary btn-sm" href="{% url 'web_home' %}">Home</a>
    </div>
  </div>
  <div class="d-flex align-items-center justify-content-between mt-2">
    <div class="meta">
      {% if lesson.part_type %}
        <span class="meta-chip primary">Part: {{ lesson.part_type|title }}</span>
      {% endif %}
      {% if chapter_title %}
        <span class="meta-chip">Chapter: {{ chapter_title }}</span>
      {% endif %}
    </div>
    {% if not limited and lesson.pdf %}
      <a class="btn btn-outline-primary btn-sm" href="{{ lesson.pdf }}" target="_blank" rel="noopener">üìÑ Open PDF</a>
    {% endif %}
  </div>
  <div class="reading-progress mt-2"><div id="reading-bar" class="bar"></div></div>
</div>

<div class="row g-3" id="lesson-layout">
  <div class="col-12 col-lg-8">

    <div class="card-soft p-3 mb-3">
      <div class="d-flex flex-wrap gap-2 align-items-center justify-content-between">
        <div class="small text-muted">
          {% if lesson.part_type %}Part: <span class="fw-semibold">{{ lesson.part_type|title }}</span>{% endif %}
          {% if chapter_title %} ¬∑ Chapter: <span class="fw-semibold">{{ chapter_title }}</span>{% endif %}
        </div>
        <div class="d-flex gap-2 align-items-center">
          <span id="done-{{ lesson_id }}">
            {% include "components/_lesson_done_button.html" with lesson_id=lesson_id is_done=is_done %}
          </span>
          <span id="fav-{{ lesson_id }}">
            {% include "components/_favorite_button.html" with lesson_id=lesson_id is_fav=is_fav %}
          </span>
        </div>
      </div>
    </div>

    {# ---------- Tabs ---------- #}
    <ul class="nav nav-tabs mb-3">
      <li class="nav-item">
        <a class="nav-link active" data-bs-toggle="tab" href="#tab-content">üìò Content</a>
      </li>
      <li class="nav-item">
        <a class="nav-link"
           data-bs-toggle="tab"
           href="#tab-questions"
           hx-get="{% url 'q_panel_questions' %}?lesson_id={{ lesson_id }}"
           hx-trigger="click"
           hx-target="#tab-questions"
           hx-swap="innerHTML"
           hx-indicator="#qs-loading">
          ‚ùì Questions
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link"
           data-bs-toggle="tab"
           href="#tab-flashcards"
           hx-get="{% url 'web_flashcards_panel' lesson_id=lesson_id %}"
           hx-trigger="click"
           hx-target="#tab-flashcards"
           hx-swap="innerHTML"
           hx-indicator="#fc-loading">
          üß† Flashcards
        </a>
      </li>
    </ul>

    <div class="tab-content">
      <div id="tab-content" class="tab-pane fade show active">
        {% if limited %}
          <div class="alert alert-warning mb-3">
            {{ block_msg|default:"Subscription required to view lesson content." }}
          </div>
        {% else %}
          {% if lesson.content %}
            <div class="card-soft p-3">
              <div class="d-flex justify-content-end mb-2">
                <button type="button"
                        class="btn btn-outline-secondary btn-sm"
                        id="btn-fullscreen-toggle">
                  ‚§¢ Full width
                </button>
              </div>
              <div id="lesson-content" class="lesson-content">{{ lesson.content|safe }}</div>
            </div>
          {% else %}
            <div class="alert alert-secondary">No content available for this lesson.</div>
          {% endif %}
        {% endif %}
      </div>

      {# Questions pane (HTMX fills it) #}
      <div id="tab-questions" class="tab-pane fade position-relative">
        <div id="qs-loading" class="position-absolute top-0 end-0 me-2 mt-2 d-none">
          <span class="spinner-border spinner-border-sm"></span>
        </div>
        <div class="text-muted small">Click ‚ÄúQuestions‚Äù to load.</div>
      </div>

      {# Flashcards pane (HTMX fills it) #}
      <div id="tab-flashcards" class="tab-pane fade position-relative">
        <div id="fc-loading" class="position-absolute top-0 end-0 me-2 mt-2 d-none">
          <span class="spinner-border spinner-border-sm"></span>
        </div>
        <div class="text-muted small">Click ‚ÄúFlashcards‚Äù to load.</div>
      </div>
    </div>
  </div>

  <div class="col-12 col-lg-4">
    <div class="card-soft p-3">
      <div class="fw-semibold mb-2">Resources</div>
      {% if not limited and lesson.pdf %}
        <a class="btn btn-outline-primary w-100 mb-2" href="{{ lesson.pdf }}" target="_blank" rel="noopener">
          üìÑ Open PDF
        </a>
      {% else %}
        <div class="small text-muted">No PDF attached.</div>
      {% endif %}

      {% if subject_id %}
        <a class="btn btn-outline-secondary w-100 mt-2" href="{% url 'web_materials_home' %}?subject={{ subject_id }}">‚Üê Back to subject</a>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // Reading progress (page scroll)
  (function() {
    var bar = document.getElementById('reading-bar');
    function onScroll() {
      var doc = document.documentElement;
      var scrollTop = doc.scrollTop || document.body.scrollTop;
      var scrollHeight = doc.scrollHeight - doc.clientHeight;
      var pct = scrollHeight > 0 ? Math.min(100, Math.max(0, (scrollTop / scrollHeight) * 100)) : 0;
      if (bar) bar.style.width = pct + '%';
    }
    document.addEventListener('scroll', onScroll, { passive: true });
    onScroll();
  })();

  // Full-width toggle for lesson content
  (function() {
    var layout = document.getElementById('lesson-layout');
    var btn    = document.getElementById('btn-fullscreen-toggle');
    if (!layout || !btn) return;

    btn.addEventListener('click', function () {
      var isFull = layout.classList.toggle('lesson-fullscreen');
      btn.textContent = isFull ? '‚Ü© Exit full width' : '‚§¢ Full width';
    });
  })();
</script>
{% endblock %}
