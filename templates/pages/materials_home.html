{% extends "base.html" %}
{% block title %}Materials · Axonelix{% endblock %}

{% block content %}

{% if mode == "tree" %}
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div class="page-title">Materials</div>
    <a class="btn btn-outline-primary btn-sm" href="/">Back to Home</a>
  </div>

  {% if semesters %}
    {% for sem in semesters %}
      <div class="card-soft p-3 mb-3">
        <div class="fw-bold mb-2">Semester: {{ sem.name }}</div>

        {# Modules for this semester #}
        {% with sem_id=sem.id %}
          {% for mod in modules %}
            {% if mod.semester == sem_id %}
              <div class="card-soft p-3 mb-2">
                <div class="small text-muted mb-2">Module</div>
                <div class="fw-semibold mb-2">{{ mod.name }}</div>

                {# Subjects for this module #}
                <div class="row g-2">
                  {% with mod_id=mod.id %}
                    {% for sub in subjects %}
                      {% if sub.module == mod_id %}
                        <div class="col-12 col-md-6 col-lg-4">
                          <div class="card-soft p-3 d-flex flex-column gap-1 h-100">
                            <div class="fw-bold">{{ sub.name }}</div>
                            <div class="small text-muted">Module ID: {{ sub.module }}</div>
                            <a class="btn btn-primary btn-sm mt-2" href="/materials/?subject={{ sub.id }}">Open</a>
                          </div>
                        </div>
                      {% endif %}
                    {% endfor %}
                  {% endwith %}
                </div>
              </div>
            {% endif %}
          {% endfor %}
        {% endwith %}
      </div>
    {% endfor %}
  {% else %}
    <div class="alert alert-secondary">No semesters available yet.</div>
  {% endif %}

{% elif mode == "subject_detail" %}
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div class="d-flex align-items-center gap-2">
      <a href="/materials/" class="btn btn-outline-secondary btn-sm">← Back</a>
      <div class="page-title mb-0">{{ subject_name }}</div>
    </div>
    <a class="btn btn-outline-primary btn-sm" href="/">Home</a>
  </div>

  {# Part type filters #}
  <div class="d-flex flex-wrap gap-2 mb-3">
    <a class="btn btn-sm {% if not active_part_type %}btn-primary{% else %}btn-outline-primary{% endif %}"
       href="/materials/?subject={{ subject_id }}{% if active_chapter %}&chapter={{ active_chapter }}{% endif %}">
      All parts
    </a>
    <a class="btn btn-sm {% if active_part_type == 'theoretical' %}btn-primary{% else %}btn-outline-primary{% endif %}"
       href="/materials/?subject={{ subject_id }}{% if active_chapter %}&chapter={{ active_chapter }}{% endif %}&part_type=theoretical">
      Theory
    </a>
    <a class="btn btn-sm {% if active_part_type == 'practical' %}btn-primary{% else %}btn-outline-primary{% endif %}"
       href="/materials/?subject={{ subject_id }}{% if active_chapter %}&chapter={{ active_chapter }}{% endif %}&part_type=practical">
      Practical
    </a>
  </div>

  {# Chapters FIRST #}
    {% if chapters and chapters|length > 0 %}
    <div class="d-flex flex-wrap gap-2 mb-3">
        <a class="btn btn-outline-secondary btn-sm {% if not active_chapter %}active{% endif %}"
        href="/materials/?subject={{ subject_id }}{% if active_part_type %}&part_type={{ active_part_type }}{% endif %}">
        All chapters
        </a>
        {% for c in chapters %}
        <a class="btn btn-outline-secondary btn-sm {% if active_chapter == c.id|stringformat:'s' %}active{% endif %}"
            href="/materials/?subject={{ subject_id }}&chapter={{ c.id }}{% if active_part_type %}&part_type={{ active_part_type }}{% endif %}">
            {{ c.title }}
        </a>
        {% endfor %}
    </div>
    {% endif %}


  {# Lessons ONLY AFTER a chapter is chosen #}
  {% if active_chapter %}
    <div class="d-flex align-items-center justify-content-between mb-2">
      <div class="h5 mb-0">Lessons</div>
      <a class="btn btn-outline-secondary btn-sm"
         href="/materials/?subject={{ subject_id }}{% if active_part_type %}&part_type={{ active_part_type }}{% endif %}">
        Clear chapter filter
      </a>
    </div>

    {% if lessons and lessons|length > 0 %}
      <div class="row g-3">
        {% for l in lessons %}
            <div class="d-flex align-items-center justify-content-between">
            <div>
                <div class="fw-bold">{{ l.title }}</div>
                {% if l.part_type %}
                <div class="small text-muted">Part: {{ l.part_type|title }}</div>
                {% endif %}
            </div>

            <div class="d-flex gap-2 align-items-center">
                <span id="fav-{{ l.id }}">
                    {% if favorite_ids and l.id in favorite_ids %}
                        {% include "components/_favorite_button.html" with lesson_id=l.id is_fav=True %}
                    {% else %}
                        {% include "components/_favorite_button.html" with lesson_id=l.id is_fav=False %}
                    {% endif %}
                </span>


                <a class="btn btn-primary btn-sm" href="/materials/lesson/{{ l.id }}/">Open lesson</a>
            </div>
            </div>

        {% endfor %}
      </div>
    {% else %}
      <div class="alert alert-secondary">No lessons found for this chapter{% if active_part_type %} and part{% endif %}.</div>
    {% endif %}
  {% else %}
    <div class="alert alert-secondary">Select a chapter to view lessons{% if active_part_type %} ({{ active_part_type|title }}){% endif %}.</div>
  {% endif %}
{% endif %}


{# ضعه مثلاً في آخر الصفحة أو داخل block scripts إن وجد #}
<script src="https://unpkg.com/htmx.org@1.9.12"></script>
<script>
  function getCookie(name) {
    const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return v ? v.pop() : '';
  }
  document.body.addEventListener('htmx:configRequest', (e) => {
    e.detail.headers['X-CSRFToken'] = getCookie('csrftoken');
  });
</script>

{% endblock %}
